{% extends "core/base.html" %}
{% load static %}
{% block content %}
<h1>Project Settings: {{ project.project_name }}</h1>

<a href="{% url 'project_detail' project.id %}">
    <button class="btn btn-primary">&#x2190; Back</button>
</a>

<hr>

<h2>Update Project Info</h2>
<form method="post">
    {% csrf_token %}
    {{ form.as_p }}
    <button type="submit" name="save_project">Save Changes</button>
</form>

<hr>

<h2>Collaborators</h2>
<ul>
    {% for membership in project.memberships.all %}
        <li>
            {{ membership.user.username }} - {{ membership.role }}

            {% if membership.role != "owner" %}
            <form method="post" style="display:inline;">
                {% csrf_token %}
                <input type="hidden" name="delete_membership_id" value="{{ membership.id }}">
                <button type="submit" class="btn btn-sm btn-danger"
                        onclick="return confirm('Remove {{ membership.user.username }}?');">
                    Remove
                </button>
            </form>
            {% endif %}
        </li>
    {% empty %}
        <li>No collaborators yet.</li>
    {% endfor %}
</ul>

<h3>Invite a Collaborator</h3>
<form method="post">
    {% csrf_token %}
    <button type="submit" name="generate_invite">Generate Invite Link</button>
</form>

{% if invite_link %}
    <p>Copy this single-use link and share it with your collaborator:</p>
    <div class="input-group mb-3">
        <input type="text" id="inviteLinkInput" value="{{ invite_link }}" readonly class="form-control">
        <button class="btn btn-outline-secondary" type="button" id="copyInviteBtn">Copy</button>
    </div>
    <small id="copyFeedback" class="text-success" style="display:none;">Copied!</small>

    <script>
        document.getElementById("copyInviteBtn").addEventListener("click", function() {
            const input = document.getElementById("inviteLinkInput");
            input.select();
            input.setSelectionRange(0, 99999); // For mobile devices

            // Copy to clipboard
            navigator.clipboard.writeText(input.value).then(() => {
                const feedback = document.getElementById("copyFeedback");
                feedback.style.display = "inline";
                setTimeout(() => { feedback.style.display = "none"; }, 1500);
            }).catch(err => {
                alert("Failed to copy link: " + err);
            });
        });
    </script>
{% endif %}

<hr>

<h2>Delete Project</h2>
<form method="post">
    {% csrf_token %}
    <button type="submit" name="delete_project" onclick="return confirm('Are you sure you want to delete this project?');">
        Delete Project
    </button>
</form>
{% endblock %}
