{% extends "core/base.html" %}
{% load custom_filters %}

{% block content %}
<h2>Add Subject Data for {{ project.project_name }}</h2>
<a href="{% url 'subject_data' project.id %}">
    <button class="btn btn-primary">&#x2190; Back</button>
</a>

{% if request.user == project.owner %}
    <!-- Step 1: Upload CSV -->
    <form method="post" enctype="multipart/form-data" class="mb-4">
        {% csrf_token %}
        {{ upload_form.as_p }}
        <button type="submit" name="upload_csv" class="btn btn-primary">Upload CSV</button>
    </form>
{% else %}
    <p>You are not allowed to add subjects to this project.</p>
{% endif %}

{% if subjects %}
    <!-- Step 2: Select Subjects to Add -->
    <form method="post" id="subjectForm">
        {% csrf_token %}
        <div class="mb-3">
            {{ selection_form.group.label_tag }} {{ selection_form.group }}
        </div>

        <h3 id="subjectCounter">Add 0 Subjects to Selected Group</h3>

        <table class="table table-striped" id="subjectTable">
            <thead>
                <tr>
                    <th>Select</th>
                    {% for key in subjects.0.keys %}
                        <th class="sortable">{{ key }} <span class="sort-arrow">&#9650;</span></th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for subject, checkbox in subjects|zip_lists:selection_form.subjects %}
                <tr>
                    <td>{{ checkbox }}</td>
                    {% for value in subject.values %}
                        <td>{{ value }}</td>
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <button type="submit" name="add_subjects" class="btn btn-success">Add Selected Subjects</button>
    </form>
{% else %}
    <p>No subjects uploaded yet. Please upload a CSV to see the preview.</p>
{% endif %}

{% if messages %}
<ul class="mt-3">
    {% for message in messages %}
        <li>{{ message }}</li>
    {% endfor %}
</ul>
{% endif %}

<style>
/* Arrow styling */
th.sortable {
    cursor: pointer;
    position: relative;
    user-select: none;
}

th.sortable .sort-arrow {
    font-size: 0.8em;
    margin-left: 5px;
    transition: transform 0.2s ease;
    display: none; /* hidden by default */
}

th.sortable.sorted-asc .sort-arrow {
    display: inline-block;
    transform: rotate(180deg);
}

th.sortable.sorted-desc .sort-arrow {
    display: inline-block;
    transform: rotate(0deg);
}
</style>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const checkboxes = document.querySelectorAll("input[type=checkbox]");
    const counter = document.getElementById("subjectCounter");

    function updateCounter() {
        const selectedCount = document.querySelectorAll("input[type=checkbox]:checked").length;
        const groupSelect = document.querySelector("select[name=group]");
        const groupName = groupSelect ? groupSelect.options[groupSelect.selectedIndex].text : "Group";
        counter.textContent = `Add ${selectedCount} Subjects to "${groupName}"`;
    }

    checkboxes.forEach(cb => cb.addEventListener("change", updateCounter));
    const groupSelect = document.querySelector("select[name=group]");
    if (groupSelect) groupSelect.addEventListener("change", updateCounter);

    updateCounter();
});
</script>

<!-- Include Tablesort JS -->
<script src="https://cdn.jsdelivr.net/npm/tablesort@5.2.1/dist/tablesort.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function() {
    const table = document.getElementById("subjectTable");
    const ts = new Tablesort(table);

    // Update arrow rotation and visibility on sort
    table.querySelectorAll("th.sortable").forEach(th => {
        th.addEventListener("click", () => {
            table.querySelectorAll("th.sortable").forEach(h => h.classList.remove("sorted-asc", "sorted-desc"));
            if (th.classList.contains("asc")) {
                th.classList.add("sorted-asc");
            } else if (th.classList.contains("desc")) {
                th.classList.add("sorted-desc");
            }
        });
    });
});
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
{% endblock %}
