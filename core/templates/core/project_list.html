{% extends "core/base.html" %}
{% block content %}
<div class="container mt-4">

  <h2 class="mb-4">Projects</h2>

  <!-- Search Form -->
  <div class="mb-3 d-flex gap-2">
    <input type="text" id="searchName" class="form-control" placeholder="Search by project name...">
    <input type="text" id="searchCreator" class="form-control" placeholder="Search by creator...">
  </div>

  <!-- Projects Table -->
  <div class="table-responsive">
    <table class="table table-hover align-middle" id="projectsTable">
      <thead class="table-light">
        <tr>
          <th>Owner</th>
          <th>Project Name</th>
          <th>Date Created</th>
        </tr>
      </thead>
      <tbody>
        {% for project in projects %}
        <tr style="cursor: pointer;" onclick="window.location='{% url 'project_detail' project.id %}';">
          <td>{{ project.owner.username }}</td>
          <td>
            {{ project.project_name }}
            <span
              class="ms-2 text-muted"
              data-bs-toggle="tooltip"
              data-bs-placement="top"
              title="{{ project.description|truncatechars:100|default:'No description provided' }}">
              <i class="bi bi-question-circle"></i>
            </span>
          </td>
          <td>{{ project.created_at|date:"M d, Y" }}</td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="3" class="text-center">No projects yet.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Pagination Controls -->
  <nav>
    <ul class="pagination justify-content-center" id="pagination"></ul>
  </nav>

    <button class="btn btn-success mt-3" onclick="createNewProject()">Create a New Project</button>

</div>

<!-- Bootstrap Icons (for the question mark icon) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

<!-- Client-side Search + Pagination + Tooltip Init -->
<script>
document.addEventListener("DOMContentLoaded", function () {
    const rows = Array.from(document.querySelectorAll("#projectsTable tbody tr"));
    const rowsPerPage = 10;
    let currentPage = 1;

    const pagination = document.getElementById("pagination");
    const searchName = document.getElementById("searchName");
    const searchCreator = document.getElementById("searchCreator");

    function filterRows() {
        const nameVal = searchName.value.toLowerCase();
        const creatorVal = searchCreator.value.toLowerCase();
        return rows.filter(row => {
            const creator = row.cells[0]?.innerText.toLowerCase();
            const name = row.cells[1]?.innerText.toLowerCase();
            return creator.includes(creatorVal) && name.includes(nameVal);
        });
    }

    function renderTable() {
        const filtered = filterRows();
        const start = (currentPage - 1) * rowsPerPage;
        const end = start + rowsPerPage;

        rows.forEach(row => row.style.display = "none");
        filtered.slice(start, end).forEach(row => row.style.display = "");

        renderPagination(filtered.length);
    }

    function renderPagination(totalItems) {
        const totalPages = Math.ceil(totalItems / rowsPerPage);
        pagination.innerHTML = "";

        if (totalPages <= 1) return;

        for (let i = 1; i <= totalPages; i++) {
            const li = document.createElement("li");
            li.className = `page-item ${i === currentPage ? "active" : ""}`;
            const link = document.createElement("a");
            link.className = "page-link";
            link.href = "#";
            link.innerText = i;
            link.addEventListener("click", function (e) {
                e.preventDefault();
                currentPage = i;
                renderTable();
            });
            li.appendChild(link);
            pagination.appendChild(li);
        }
    }

    searchName.addEventListener("input", () => { currentPage = 1; renderTable(); });
    searchCreator.addEventListener("input", () => { currentPage = 1; renderTable(); });

    renderTable();


    // Enable Bootstrap tooltips
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    tooltipTriggerList.map(function (tooltipTriggerEl) {
      return new bootstrap.Tooltip(tooltipTriggerEl)
    })
});

function createNewProject() {
// Open tutorial in a new tab
window.open("{% url 'tutorial' 1 %}", "_blank");

// Redirect current page to the project creation page
window.location.href = "{% url 'start_project' %}";
}

</script>
{% endblock %}
