{% extends "core/base.html" %}
{% block content %}
<h1>{{ project.project_name }}</h1>
<p>{{ project.description }}</p>
<p>Groups: {{ project.group_names }}</p>

{% if request.user == project.owner %}
    <a href="{% url 'add_subject_data' project.id %}" class="btn btn-primary mb-3">
        + Add Subject Data
    </a>

{% else %}
    <button class="btn btn-secondary mb-3" disabled title="Only the project owner can add subject data">
        + Add Subject Data
    </button>
{% endif %}

<br>
    <a href="{% url 'view_files' project.id %}" >
        <button class="btn btn-primary">View Project Info Files</button>
    </a>

<h2>Data:</h2>
<table class="table table-striped align-middle">
    <thead>
        <tr>
            <th>Group</th>
        </tr>
    </thead>
    <tbody>
        {% for group in group_data %}
        <!-- Toggler row (click to expand/collapse) -->
        <tr role="button"
            data-bs-toggle="collapse"
            data-bs-target="#group-data-{{ group.id }}"
            aria-expanded="false"
            aria-controls="group-data-{{ group.id }}"
            style="cursor: pointer;">
            <td colspan="4">
                <strong>{{ group.group_name }}</strong>
                {% if group.group_sub_data.count %} (click to expand/collapse) {% else %}
                    <span class="text-muted">(no data)</span>
                {% endif %}
            </td>
        </tr>

        <!-- Collapsible content row -->
        <tr>
          <td colspan="4" class="p-0">
            <div id="group-data-{{ group.id }}" class="collapse">
              {% if group.group_sub_data.all %}
              <table class="table mb-0">
                  <thead>
                      <tr>
                          <th style="width: 25%;">Category</th>
                          <th style="width: 25%;">Label</th>
                          <th>Value</th>
                      </tr>
                  </thead>
                  <tbody>
                      {% for sub in group.group_sub_data.all %}
                      <tr>
                          <td>{{ sub.category }}</td>
                          <td>{{ sub.label }}</td>
                          <td>{{ sub.value }}</td>
                      </tr>
                      {% endfor %}
                  </tbody>
              </table>
              {% else %}
              <div class="text-muted p-2">No sub-data</div>
              {% endif %}
            </div>
          </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<h2>Subjects:</h2>
<table class="table table-striped align-middle">
    <thead>
        <tr>
            <th>Group</th>
            <th>Subjects</th>
        </tr>
    </thead>
    <tbody>
        {% for group in project.group_data.all %}
        <!-- Toggler row (click to expand/collapse) -->
        <tr role="button"
            data-bs-toggle="collapse"
            data-bs-target="#subjects-{{ group.id }}"
            aria-expanded="false"
            aria-controls="subjects-{{ group.id }}"
            style="cursor: pointer;">
            <td colspan="2">
                <strong>{{ group.group_name }}</strong>
                {% if group.subjects.count %} (click to expand/collapse) {% else %}
                    <span class="text-muted">(no subjects)</span>
                {% endif %}
            </td>
        </tr>

        <!-- Collapsible content row -->
        <tr>
          <td colspan="2" class="p-0">
            <div id="subjects-{{ group.id }}" class="collapse">
              {% if group.subjects.all %}
              <table class="table mb-0">
                  <thead>
                      <tr>
                          <th style="width: 200px;">Subject</th>
                          <th>Metadata</th>
                      </tr>
                  </thead>
                  <tbody>
                      {% for subject in group.subjects.all %}
                      <tr>
                          <td>#{{ subject.id }}</td>
                          <td>
                              {% if subject.metadata %}
                              <!-- Render key â†’ value pairs -->
                              <div class="row row-cols-1 row-cols-md-2 g-2">
                                  {% for k, v in subject.metadata.items %}
                                  <div class="col">
                                      <div class="border rounded p-2">
                                          <div class="small text-muted">{{ k }}</div>
                                          <div>{{ v }}</div>
                                      </div>
                                  </div>
                                  {% endfor %}
                              </div>
                              {% else %}
                              <span class="text-muted">No metadata</span>
                              {% endif %}
                          </td>
                      </tr>
                      {% endfor %}
                  </tbody>
              </table>
              {% else %}
              <div class="text-muted p-2">No subjects in this group.</div>
              {% endif %}
            </div>
          </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<!-- Bootstrap JS (Collapse requires this) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
{% endblock %}
